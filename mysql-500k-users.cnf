# ============================================================================
# MySQL Server Configuration for 500K Users
# ============================================================================
# 
# This configuration is optimized for high-concurrency workloads.
# Adjust values based on your server's available RAM and CPU cores.
# 
# Recommended Server Specs:
# - Primary: 16 vCPU, 128GB RAM, SSD storage
# - Replicas: 16 vCPU, 128GB RAM, SSD storage
# 
# File Location: /etc/mysql/mysql.conf.d/mysqld.cnf (Ubuntu/Debian)
#                /etc/my.cnf (CentOS/RHEL)
# ============================================================================

[mysqld]

# ============================================================================
# CONNECTION SETTINGS (For 500K Users)
# ============================================================================

# Maximum simultaneous connections
max_connections = 5000              # Primary server
# max_connections = 10000           # Uncomment for read replicas

# Connection error handling
max_connect_errors = 100000
connect_timeout = 10
wait_timeout = 600                  # Close idle connections after 10 minutes
interactive_timeout = 600

# Thread handling
thread_cache_size = 100
thread_stack = 256K

# ============================================================================
# INNODB SETTINGS (Performance Optimization)
# ============================================================================

# Buffer Pool (Use 70-80% of available RAM)
innodb_buffer_pool_size = 96G       # Adjust based on your RAM (e.g., 96GB for 128GB server)
innodb_buffer_pool_instances = 16  # Number of buffer pool instances (1 per 1GB, max 64)

# Log Files
innodb_log_file_size = 2G           # Larger = better write performance
innodb_log_buffer_size = 64M
innodb_flush_log_at_trx_commit = 2  # 0=fastest, 1=safest, 2=balanced

# I/O Configuration
innodb_flush_method = O_DIRECT      # Bypass OS cache for better performance
innodb_io_capacity = 2000           # IOPS capability (adjust for SSD)
innodb_io_capacity_max = 4000
innodb_read_io_threads = 16         # Parallel read threads
innodb_write_io_threads = 16        # Parallel write threads

# Concurrency
innodb_thread_concurrency = 0       # 0 = auto-tune based on CPU cores
innodb_concurrency_tickets = 5000

# File per table
innodb_file_per_table = 1

# Adaptive hash index
innodb_adaptive_hash_index = 1

# ============================================================================
# QUERY CACHE (Disabled in MySQL 8.0+)
# ============================================================================
# Note: Query cache is removed in MySQL 8.0+
# Use application-level caching (Redis) instead

# query_cache_type = 0              # Disabled
# query_cache_size = 0

# ============================================================================
# TEMPORARY TABLES & MEMORY
# ============================================================================

tmp_table_size = 256M
max_heap_table_size = 256M
sort_buffer_size = 4M               # Per-connection buffer
read_buffer_size = 2M
read_rnd_buffer_size = 4M
join_buffer_size = 4M

# ============================================================================
# BINARY LOGGING (For Replication)
# ============================================================================

# Enable binary logging for replication
server_id = 1                       # Unique ID (1 for primary, 2+ for replicas)
log_bin = /var/log/mysql/mysql-bin.log
binlog_format = ROW                 # ROW, STATEMENT, or MIXED
binlog_expire_logs_seconds = 604800 # Keep logs for 7 days
max_binlog_size = 1G
sync_binlog = 1                     # 1=safest, 0=fastest

# GTID (Global Transaction Identifier) - Recommended for replication
gtid_mode = ON
enforce_gtid_consistency = ON

# ============================================================================
# REPLICATION SETTINGS (For Read Replicas)
# ============================================================================

# On Primary Server:
# (No additional settings needed beyond binary logging)

# On Replica Servers (uncomment these):
# read_only = 1                     # Prevent writes on replicas
# super_read_only = 1               # Even root cannot write
# relay_log = /var/log/mysql/relay-bin
# relay_log_recovery = 1
# slave_parallel_workers = 8        # Parallel replication threads
# slave_parallel_type = LOGICAL_CLOCK

# ============================================================================
# SLOW QUERY LOG (Performance Monitoring)
# ============================================================================

slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 2                 # Log queries taking > 2 seconds
log_queries_not_using_indexes = 0  # Set to 1 to log unindexed queries

# ============================================================================
# ERROR LOG
# ============================================================================

log_error = /var/log/mysql/error.log

# ============================================================================
# CHARACTER SET
# ============================================================================

character_set_server = utf8mb4
collation_server = utf8mb4_unicode_ci

# ============================================================================
# SECURITY
# ============================================================================

# Disable local file loading
local_infile = 0

# Skip DNS resolution for faster connections
skip_name_resolve = 1

# ============================================================================
# PERFORMANCE SCHEMA (Monitoring)
# ============================================================================

performance_schema = ON
performance_schema_max_table_instances = 12500
performance_schema_max_table_handles = 4000

# ============================================================================
# TABLE CACHE
# ============================================================================

table_open_cache = 4000
table_definition_cache = 2000
open_files_limit = 65535

# ============================================================================
# NETWORKING
# ============================================================================

max_allowed_packet = 256M           # Maximum packet size
net_read_timeout = 60
net_write_timeout = 60

# ============================================================================
# NOTES FOR PRODUCTION DEPLOYMENT
# ============================================================================
# 
# 1. After updating this file, restart MySQL:
#    sudo systemctl restart mysql
# 
# 2. Verify settings:
#    mysql -u root -p -e "SHOW VARIABLES LIKE 'max_connections';"
#    mysql -u root -p -e "SHOW VARIABLES LIKE 'innodb_buffer_pool_size';"
# 
# 3. Monitor performance:
#    mysql -u root -p -e "SHOW GLOBAL STATUS LIKE 'Threads_connected';"
#    mysql -u root -p -e "SHOW GLOBAL STATUS LIKE 'Max_used_connections';"
# 
# 4. Check slow queries:
#    sudo tail -f /var/log/mysql/slow-query.log
# 
# 5. For 500K users, you MUST use:
#    - ProxySQL for connection pooling
#    - At least 3-4 read replicas
#    - Load balancer for application servers
# 
# ============================================================================
